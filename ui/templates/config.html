{% load static %}
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>„Éõ„Éº„É†„Éö„Éº„Ç∏</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="{% static 'ui/editor.js' %}"></script>
</head>

<body class="bg-gray-50">
    <header class="bg-blue-900 p-6">
        <h1 class="text-2xl font-bold">BT</h1>
    </header>
    <nav class="flex gap-8 bg-gray-800 p-6">
        <a href="/" class="bg-gray-200 p-3" href>„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</a>
        <a href="/prediction-1" class="bg-gray-200 p-3" href>‰∫ãÂâç‰∫àÊÉ≥</a>
        <a href="/prediction-2" class="bg-gray-200 p-3" href>Áõ¥Ââç‰∫àÊÉ≥</a>
        <a href="/report" class="bg-gray-200 p-3" href>‰∫àÊÉ≥ÁµêÊûú</a>
        <a href="/result" class="bg-gray-200 p-3" href>ÁµêÊûúÁîªÈù¢‰ΩúÊàê</a>
        <a href="/media" class="bg-gray-200 p-3" href>„É°„Éá„Ç£„Ç¢</a>
        <a href="/config" class="bg-gray-200 p-3" href>Ë®≠ÂÆö</a>
    </nav>
    <main class="p-6">
        <div class="max-w-5xl mx-auto">

            <h1 class="text-2xl font-bold mb-12">Ë®≠ÂÆöÁîªÈù¢</h1>

            <!-- Áï™ÁµÑË®≠ÂÆö -->
            <div class="border rounded p-6 mb-12 bg-gray-100">
                <h2 class="text-xl font-semibold mb-3">Áï™ÁµÑË®≠ÂÆö</h2>
                <form method="post">
                    {% csrf_token %}
                    <div class="flex justify-between gap-8 items-center mb-3">

                        <input type="text" name="name" placeholder="Áï™ÁµÑÂêç„ÇíÂÖ•Âäõ" class="border rounded p-2 w-10/12 h-12"
                            value="{{ program.name|default:'' }}">


                        <button type="submit" name="program_save"
                            class="bg-blue-500 text-white px-3 py-2 rounded grow">‰øùÂ≠ò</button>

                    </div>
                </form>
            </div>

            <!-- „Ç≠„É£„É©„ÇØ„Çø„Éº‰∏ÄË¶ß -->
            <div class="border rounded px-6 pt-6 pb-4 mb-12 bg-gray-100">
                <!-- „Ç≠„É£„É©„ÇØ„Çø„Éº‰∏ÄË¶ß -->
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold">„Ç≠„É£„É©„ÇØ„Çø„Éº</h2>
                    <button onclick="openCharacterModal()"
                        class="bg-green-500 text-white  px-3 py-2 rounded">ÔºãËøΩÂä†</button>
                </div>

                {% for c in characters %}
                <div class="flex gap-8 w-full justify-between border rounded items-center mb-2 bg-white">
                    <div class="p-3">
                        {{ c.name }}
                    </div>
                    <div class="p-3">
                        <button class="bg-blue-500 text-white px-2 py-1 rounded open-char-btn" data-id="{{ c.id }}"
                            data-name="{{ c.name }}" data-tone="{{ c.tone }}" data-prediction="{{ c.prediction }}"
                            data-index="{{ c.index }}">
                            Á∑®ÈõÜ
                        </button>
                        <form method="post" style="display:inline;">
                            {% csrf_token %}
                            <input type="hidden" name="id" value="{{ c.id }}">
                            <button name="character_delete" class="bg-red-500 text-white px-2 py-1 rounded">ÂâäÈô§</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- „ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß -->
            <div class="border rounded px-6 pt-6 pb-4 mb-12 bg-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold">„ÉÜ„É≥„Éó„É¨„Éº„Éà</h2>
                    <button onclick="openTemplateModal()" class="bg-green-500 text-white px-3 py-2 rounded">ÔºãËøΩÂä†</button>
                </div>

                {% for t in templates %}
                <div class="flex justify-between gap-8 w-full border rounded items-center mb-2 bg-white">
                    <div class="p-3">{{ t.name }}</div>
                    <div class="p-3">
                        <button class="bg-blue-500 text-white px-2 py-1 rounded open-temp-btn" data-id="{{ t.id }}"
                            data-name="{{ t.name }}" data-tag="{{ t.tag }}" data-content="{{ t.content }}">
                            Á∑®ÈõÜ
                        </button>
                        <form method="post" style="display:inline;">
                            {% csrf_token %}
                            <input type="hidden" name="id" value="{{ t.id }}">
                            <button name="template_delete" class="bg-red-500 text-white px-2 py-1 rounded">ÂâäÈô§</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- „Ç≠„É£„É©„ÇØ„Çø„Éº„É¢„Éº„ÉÄ„É´ -->
            <div id="characterModal"
                class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
                <div class="bg-white p-6 rounded shadow-lg w-96 relative">
                    <button onclick="closeModal('characterModal')"
                        class="absolute top-2 right-3 text-gray-600 text-xl">&times;</button>
                    <h2 class="text-lg font-bold mb-4">„Ç≠„É£„É©„ÇØ„Çø„ÉºÁ∑®ÈõÜ</h2>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="id" id="charId">
                        <label>ÂêçÂâç</label><input type="text" name="name" id="charName"
                            class="w-full border p-2 mb-2 rounded">
                        <label>Âè£Ë™ø</label><textarea name="tone" id="charTone"
                            class="w-full border p-2 mb-2 rounded"></textarea>
                        <label>‰∫àÊÉ≥</label><textarea name="prediction" id="charPred"
                            class="w-full border p-2 mb-2 rounded"></textarea>
                        <label>ÊåáÊï∞</label><input type="text" name="index" id="charIndex"
                            class="w-full border p-2 mb-2 rounded">
                        <div class="flex justify-end gap-3 mt-4">
                            <button type="button" class="px-3 py-2 bg-gray-300 rounded"
                                onclick="closeModal('characterModal')">Èñâ„Åò„Çã</button>
                            <button type="submit" name="character_save"
                                class="px-3 py-2 bg-blue-500 text-white rounded">‰øùÂ≠ò</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- „ÉÜ„É≥„Éó„É¨„Éº„Éà„É¢„Éº„ÉÄ„É´ -->
            <div id="templateModal"
                class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
                <div class="bg-white p-6 rounded shadow-lg w-96 relative">
                    <button onclick="closeModal('templateModal')"
                        class="absolute top-2 right-3 text-gray-600 text-xl">&times;</button>
                    <h2 class="text-lg font-bold mb-4">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ</h2>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="id" id="tempId">
                        <label>ÂêçÂâç</label><input type="text" name="name" id="tempName"
                            class="w-full border p-2 mb-2 rounded">
                        <label>„Çø„Ç∞</label><input type="text" name="tag" id="tempTag"
                            class="w-full border p-2 mb-2 rounded">
                        <label>ÂÜÖÂÆπ</label><textarea name="content" id="tempContent"
                            class="richtext w-full border p-2 mb-2 rounded"></textarea>
                        <div class="flex justify-end gap-3 mt-4">
                            <button type="button" class="px-3 py-2 bg-gray-300 rounded"
                                onclick="closeModal('templateModal')">Èñâ„Åò„Çã</button>
                            <button type="submit" name="template_save"
                                class="px-3 py-2 bg-blue-500 text-white rounded">‰øùÂ≠ò</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
    <script>
        function openCharacterModal(id = null, name = '', tone = '', prediction = '', index = '') {
            document.getElementById('charId').value = id || '';
            document.getElementById('charName').value = name || '';
            document.getElementById('charTone').value = tone || '';
            document.getElementById('charPred').value = prediction || '';
            document.getElementById('charIndex').value = index || '';
            document.getElementById('characterModal').classList.remove('hidden');
        }

        function openTemplateModal(id = null, name = '', tag = '', content = '') {
            document.getElementById('tempId').value = id || '';
            document.getElementById('tempName').value = name || '';
            document.getElementById('tempTag').value = tag || '';

            const modal = document.getElementById('templateModal');
            modal.classList.remove('hidden');

            // QuillÂàùÊúüÂåñ„ÅåÂÆå‰∫Ü„Åô„Çã„Åæ„ÅßÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÊú¨Êñá„Çí„Çª„ÉÉ„Éà
            let tries = 0;
            const interval = setInterval(() => {
                const quillEditor = modal.querySelector('.ql-editor');
                if (quillEditor) {
                    quillEditor.innerHTML = content || '';
                    console.log('ü™∂ QuillÊú¨ÊñáÂèçÊò†:', (content || '').slice(0, 60));
                    clearInterval(interval);
                }
                if (++tries > 20) {
                    clearInterval(interval);
                    console.warn('‚ö†Ô∏è Quill„ÅåË¶ã„Å§„Åã„Çâ„ÅöÊú¨Êñá„ÇíÂèçÊò†„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            }, 100);
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // „Ç≠„É£„É©Á∑®ÈõÜ„Éú„Çø„É≥
            document.querySelectorAll('.open-char-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const name = btn.dataset.name;
                    const tone = btn.dataset.tone;
                    const prediction = btn.dataset.prediction;
                    const index = btn.dataset.index;
                    openCharacterModal(id, name, tone, prediction, index);
                });
            });

            // „ÉÜ„É≥„Éó„É¨Á∑®ÈõÜ„Éú„Çø„É≥
            document.querySelectorAll('.open-temp-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const name = btn.dataset.name;
                    const tag = btn.dataset.tag;
                    const content = btn.dataset.content;
                    openTemplateModal(id, name, tag, content);
                });
            });

            // „ÄåÔºãËøΩÂä†„Äç„Éú„Çø„É≥
            const addCharBtn = document.getElementById('addCharBtn');
            if (addCharBtn) {
                addCharBtn.addEventListener('click', () => openCharacterModal());
            }

            const addTempBtn = document.getElementById('addTempBtn');
            if (addTempBtn) {
                addTempBtn.addEventListener('click', () => openTemplateModal());
            }
        });
    </script>

</html>