<h2>æœ¬æ—¥ã®å…¨ãƒ¬ãƒ¼ã‚¹</h2>
<button id="fetchAll">å…¨ã¦ã®ãƒ¬ãƒ¼ã‚¹å–å¾—</button>

<pre id="allOutput"></pre>

<div id="loading" style="display:none;">
    ğŸ”„ å–å¾—ä¸­...
</div>

<div id="raceForm" style="display:none; margin-top:20px;">
    <form id="predictionForm">

        <!-- â–¼ãƒ¬ãƒ¼ã‚¹é¸æŠ -->
        <label>ãƒ¬ãƒ¼ã‚¹</label>
        <select id="raceSelect">
            <option value="">ãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
        </select>

        <input type="hidden" id="place">
        <input type="hidden" id="title">
        <input type="hidden" id="race">
        <input type="hidden" id="deadline">
        <input type="hidden" id="raceUrl">
        <input type="hidden" id="date">
        <br><br>

        <!-- â–¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ -->
        <label>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</label>
        <select id="characterSelect">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            {% for c in characters %}
            <option value="{{ c.id }}" data-tone="{{ c.tone }}" data-prediction="{{ c.prediction }}"
                data-index="{{ c.index }}">
                {{ c.name }}
            </option>
            {% endfor %}
        </select>

        <input type="hidden" name="tone" id="charTone">
        <input type="hidden" name="prediction" id="charPrediction">
        <input type="hidden" name="index" id="charIndex">
        <br><br>

        <!-- â–¼å¼åˆ¥ -->
        <label>å¼åˆ¥</label>
        <select id="betType" name="betType">
            <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="win">å˜å‹</option>
            <option value="place">è¤‡å‹</option>
            <option value="exacta">2é€£å˜</option>
            <option value="quinella">2é€£è¤‡</option>
            <option value="trifecta">3é€£å˜</option>
            <option value="trio">3é€£è¤‡</option>
        </select>
        <br><br>

        <!-- â–¼æ–¹å¼ -->
        <label>æ–¹å¼</label>
        <select id="method" name="method">
            <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="normal">é€šå¸¸</option>
            <option value="1axle">1è‰‡è»¸æµã—</option>
            <option value="2axle">2è‰‡è»¸æµã—</option>
            <option value="3box">3è‰‡ãƒœãƒƒã‚¯ã‚¹</option>
            <option value="4box">4è‰‡ãƒœãƒƒã‚¯ã‚¹</option>
            <option value="5box">5è‰‡ãƒœãƒƒã‚¯ã‚¹</option>
        </select>
        <br><br>

        <!-- â–¼ç‚¹æ•° -->
        <label>è³¼å…¥ç‚¹æ•°</label>
        <input id="pointsInput" name="points" type="number" placeholder="ä¾‹: 5">
        <div id="pointInfo" style="margin-top:5px;color:#555;">æ–¹å¼ã‚’é¸ã‚“ã§ãã ã•ã„</div>
        <br><br>

        <!-- â–¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ hidden -->
        <input type="hidden" id="charaStyle" name="charaStyle">
        <input type="hidden" id="charaPrediction" name="charaPrediction">
        <input type="hidden" id="charaIndex" name="charaIndex">

        <button type="submit">äºˆæƒ³ã™ã‚‹</button>

    </form>
</div>

<script>

    // ========================
    // å…¨ãƒ¬ãƒ¼ã‚¹å–å¾—ï¼ˆlocalStorage ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
    // ========================
    document.getElementById("fetchAll").addEventListener("click", async () => {
        const todayKey = new Date().toISOString().slice(0, 10);
        const cacheKey = `races_${todayKey}`;
        let data = localStorage.getItem(cacheKey);

        if (data) {
            console.log("âœ… localStorage ã‹ã‚‰èª­ã¿è¾¼ã¿");
            data = JSON.parse(data);
        } else {
            console.log("âš¡ APIã‹ã‚‰å–å¾—ä¸­...");
            document.getElementById("loading").style.display = "block";
            const res = await fetch("/all_races_today/");
            data = await res.json();
            document.getElementById("loading").style.display = "none";

            localStorage.setItem(cacheKey, JSON.stringify(data));
            console.log("âœ… localStorage ã«ä¿å­˜æ¸ˆã¿");
        }

        setupRaceOptions(data);
    });

    // ========================
    // æ–¹å¼ã«ã‚ˆã‚‹ç‚¹æ•°èª¬æ˜
    // ========================
    document.getElementById("method").addEventListener("change", e => {
        const msg = {
            normal: "è‡ªç”±ã«å…¥åŠ›ã§ãã¾ã™",
            "1axle": "1è‰‡è»¸æµã—ï¼šæœ€ä½1ç‚¹ã€œæœ€å¤§5ç‚¹",
            "2axle": "2è‰‡è»¸æµã—ï¼šæœ€ä½2ç‚¹ã€œæœ€å¤§6ç‚¹",
            "3box": "3è‰‡ãƒœãƒƒã‚¯ã‚¹ï¼š3ç‚¹å›ºå®š",
            "4box": "4è‰‡ãƒœãƒƒã‚¯ã‚¹ï¼š6ç‚¹å›ºå®š",
            "5box": "5è‰‡ãƒœãƒƒã‚¯ã‚¹ï¼š10ç‚¹å›ºå®š",
        }[e.target.value];

        document.getElementById("pointInfo").textContent = msg;

        if (e.target.value.includes("box")) {
            const fixed = { "3box": 3, "4box": 6, "5box": 10 }[e.target.value];
            document.getElementById("pointsInput").value = fixed;
            document.getElementById("pointsInput").readOnly = true;
        } else {
            document.getElementById("pointsInput").readOnly = false;
            document.getElementById("pointsInput").value = "";
        }
    });

    // ========================
    // ã‚­ãƒ£ãƒ©é¸æŠï¼šhiddenã«ã‚»ãƒƒãƒˆ
    // ========================
    document.getElementById("characterSelect").addEventListener("change", function () {
        const opt = this.selectedOptions[0];
        document.getElementById("charTone").value = opt.dataset.tone || "";
        document.getElementById("charPrediction").value = opt.dataset.prediction || "";
        document.getElementById("charIndex").value = opt.dataset.index || "";
    });

    // ========================
    // ãƒ¬ãƒ¼ã‚¹é¸æŠï¼šhiddenã«ã‚»ãƒƒãƒˆ
    // ========================
    document.getElementById("raceSelect").addEventListener("change", () => {
        const v = document.getElementById("raceSelect").value;
        if (!v) return;

        const d = JSON.parse(v);
        document.getElementById("place").value = d.place;
        document.getElementById("title").value = d.title;
        document.getElementById("race").value = d.race;
        document.getElementById("deadline").value = d.time;
        document.getElementById("raceUrl").value = d.url;
        document.getElementById("date").value = new Date().toISOString().slice(0, 10);
    });

    // ========================
    // äºˆæƒ³ãƒ•ã‚©ãƒ¼ãƒ  submit
    // ========================
    document.getElementById("predictionForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const betTypeMap = {
            win: "å˜å‹", place: "è¤‡å‹", exacta: "2é€£å˜", quinella: "2é€£è¤‡",
            trifecta: "3é€£å˜", trio: "3é€£è¤‡",
        };

        const methodMap = {
            normal: "é€šå¸¸", "1axle": "1è»¸æµã—", "2axle": "2è»¸æµã—",
            "3box": "3è‰‡ãƒœãƒƒã‚¯ã‚¹", "4box": "4è‰‡ãƒœãƒƒã‚¯ã‚¹", "5box": "5è‰‡ãƒœãƒƒã‚¯ã‚¹",
        };

        const data = {
            place: document.getElementById("place").value,
            title: document.getElementById("title").value,
            race: document.getElementById("race").value,
            deadline: document.getElementById("deadline").value,
            raceUrl: document.getElementById("raceUrl").value,
            character: document.querySelector("#characterSelect option:checked").textContent.trim(),
            charTone: document.getElementById("charTone").value,
            charPrediction: document.getElementById("charPrediction").value,
            charIndex: document.getElementById("charIndex").value,
            betType: betTypeMap[document.getElementById("betType").value],
            method: methodMap[document.getElementById("method").value],
            points: document.getElementById("pointsInput").value,
        };

        // console.table(data);

        sendPrediction(data);
    });

    async function sendPrediction(data) {

        // â‘  ãƒ¬ãƒ¼ã‚¹è©³ç´°å–å¾—
        const detail = await fetch("/today_race_detail/save/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
        });
        const raceJson = await detail.json();

        // â‘¡ äºˆæ¸¬ï¼ˆã‚¹ã‚³ã‚¢ä»˜ä¸ & ä¿å­˜ï¼‰
        const res = await fetch("/race_predict/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(raceJson),
        });
        const finalJson = await res.json();

        console.log("âœ… å®Œå…¨ç‰ˆãƒ‡ãƒ¼ã‚¿:", finalJson);
        alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
    }

    // ========================
    // ãƒ¬ãƒ¼ã‚¹é¸æŠè‚¢åæ˜ 
    // ========================
    function setupRaceOptions(data) {
        document.getElementById("allOutput").textContent = JSON.stringify(data, null, 2);

        const raceSelect = document.getElementById("raceSelect");
        raceSelect.innerHTML = `<option value="">ãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>`;

        data.forEach(site => {
            site.races.forEach(r => {
                const opt = document.createElement("option");
                opt.value = JSON.stringify({
                    place: site.place, title: site.title,
                    race: r.rno, time: r.time, url: r.url
                });
                opt.textContent = `${site.place} ${r.rno} (${r.time})`;
                raceSelect.appendChild(opt);
            });
        });

        document.getElementById("raceForm").style.display = "block";
    }

</script>