{% load static %}
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="{% static 'ui/editor.js' %}"></script>
</head>


<body class="bg-gray-50">
    <header class="bg-blue-900 p-6">
        <h1 class="text-2xl font-bold">BT</h1>
    </header>
    <nav class="flex gap-8 bg-gray-800 p-6">
        <a href="/" class="bg-gray-200 p-3" href>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
        <a href="/prediction-1" class="bg-gray-200 p-3" href>äº‹å‰äºˆæƒ³</a>
        <a href="/prediction-2" class="bg-gray-200 p-3" href>ç›´å‰äºˆæƒ³</a>
        <a href="/report" class="bg-gray-200 p-3" href>äºˆæƒ³çµæœ</a>
        <a href="/result" class="bg-gray-200 p-3" href>çµæœç”»é¢ä½œæˆ</a>
        <a href="/media" class="bg-gray-200 p-3" href>ãƒ¡ãƒ‡ã‚£ã‚¢</a>
        <a href="/config" class="bg-gray-200 p-3" href>è¨­å®š</a>
    </nav>

    <main class="p-6">
        <h2 class="text-xl font-semibold mb-4">çµæœã‚’æ§‹ç¯‰</h2>

        {% if error %}
        <p class="text-red-600 font-bold mb-4">âš ï¸ ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: {{ error }}</p>
        {% else %}
        <form method="post" id="config-form" class="space-y-4">
            {% csrf_token %}
            <button type="submit" id="load-data" class="bg-blue-600 text-white px-4 py-2 rounded">
                ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            </button>

            <div class="mt-6">
                <label class="font-semibold">è©¦è¡Œã‚»ãƒƒãƒˆæ•°</label>
                <select id="set-count" class="border p-2 rounded ml-2">
                    <option value="0" selected>é¸æŠã—ã¦ãã ã•ã„</option>
                    {% for i in range_list %}
                    <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="sets-container" class="mt-4"></div>

            <!-- ğŸ’¾ ä¿å­˜ãƒœã‚¿ãƒ³ -->
            <div class="mt-6">
                <button type="button" id="save-report" class="bg-green-600 text-white px-4 py-2 rounded">
                    ğŸ’¾ ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜
                </button>
                <div id="loading" style="display:none;" class="text-blue-700 mt-2 font-semibold">
                    ğŸ”„ ãƒ‡ãƒ¼ã‚¿ä½œæˆä¸­...
                </div>
            </div>

        </form>
        {% endif %}
    </main>

    {% if venues %}
    {{ venues|json_script:"venues-data" }}
    {% endif %}

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const venues = JSON.parse(document.getElementById("venues-data").textContent);
            const setsContainer = document.getElementById("sets-container");
            const setCountSelect = document.getElementById("set-count");

            // --- ã‚»ãƒƒãƒˆæ•°é¸æŠæ™‚ ---
            setCountSelect.addEventListener("change", () => {
                const count = parseInt(setCountSelect.value);
                setsContainer.innerHTML = "";
                if (!count) return;

                for (let s = 1; s <= count; s++) {
                    const block = document.createElement("div");
                    block.className = "bg-white shadow p-4 rounded mb-4";

                    block.innerHTML = `
                <h3 class="text-lg font-bold mb-2">${s} ã‚»ãƒƒãƒˆç›®</h3>
                <div class="mb-3">
                    <label>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</label>
                    <select name="character_name" class="character-select border p-1 rounded ml-2">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        {% for c in characters %}
                        <option value="{{ c.name }}"
                                data-tone="{{ c.tone }}"
                                data-prediction="{{ c.prediction }}"
                                data-index="{{ c.index }}">
                            {{ c.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <input type="hidden" name="tone_${s}" id="tone_${s}">
                    <input type="hidden" name="prediction_${s}" id="prediction_${s}">
                    <input type="hidden" name="index_${s}" id="index_${s}">
                </div>

                <div class="mt-3">
                    <label>è©¦è¡Œå›æ•°</label>
                    <select class="rotation-select border p-1 rounded ml-2">
                        <option value="0" selected>é¸æŠã—ã¦ãã ã•ã„</option>
                        ${[...Array(10).keys()].map(i => `<option value="${i + 1}">${i + 1}</option>`).join("")}
                    </select>
                </div>

                <div class="rotation-container mt-4"></div>
            `;

                    const rotationSelect = block.querySelector(".rotation-select");
                    const rotationContainer = block.querySelector(".rotation-container");

                    rotationSelect.addEventListener("change", () => {
                        const rotationCount = parseInt(rotationSelect.value);
                        rotationContainer.innerHTML = "";
                        if (!rotationCount) return;

                        for (let r = 1; r <= rotationCount; r++) {
                            const raceBlock = document.createElement("div");
                            raceBlock.className = "border p-3 mb-3 rounded bg-gray-50";
                            raceBlock.innerHTML = `
                        <div class="flex items-center gap-3 flex-wrap">
                            ${r} è©¦è¡Œç›®ã€€
                            <label>é‡ã¿ãƒã‚¤ãƒ³ãƒˆ</label>
                            <input type="number" class="seed-input border p-1 rounded w-24" min="0" step="1">
                            <label>åˆ†é…æ•°</label>
                            <input type="number" class="points-input border p-1 rounded w-20" min="1" step="1" value="1">
                            <label>å¯¾è±¡ãƒ¬ãƒ¼ã‚¹</label>
                            <select class="race-select border p-1 rounded w-80">
                            <option value="0">é¸æŠã—ã¦ãã ã•ã„</option>
                            ${Object.entries(venues).map(([venue, rows]) => `
                                <option disabled>â”€â”€ ${venue} â”€â”€</option>
                                ${rows.map(row => {
                                const [race, combo, pay_text, odds_suffix, pop_suffix, time, href] = row;  // â† time ã‚’è¿½åŠ 
                                return `<option value="${href}" data-venue="${venue}">${race} ${combo} ${pay_text}${odds_suffix}${pop_suffix} ğŸ•’${time}</option>`;
                            }).join("")}
                            `).join("")}
                            </select>
                        </div>
                        <p class="result-display text-green-600 font-semibold ml-4 mt-1"></p>
                    `;

                            // --- è¨ˆç®—ã‚¤ãƒ™ãƒ³ãƒˆ ---
                            const inputs = raceBlock.querySelectorAll("input, select");
                            inputs.forEach(el => {
                                el.addEventListener("input", () => {
                                    const seed = parseFloat(raceBlock.querySelector(".seed-input").value) || 0;
                                    const pointsRaw = parseFloat(raceBlock.querySelector(".points-input").value);
                                    const points = (pointsRaw && pointsRaw > 0) ? pointsRaw : 1;
                                    const selected = raceBlock.querySelector(".race-select");
                                    const text = selected.options[selected.selectedIndex]?.text || "";
                                    const match = text.match(/ï¼ˆ\s*([\d.]+)\s*å€ï¼‰/);
                                    const odds = match ? parseFloat(match[1]) : 0;

                                    const perTicket = seed / points;
                                    const total = Math.floor(perTicket * odds);

                                    raceBlock.querySelector(".result-display").textContent =
                                        (odds > 0 && perTicket > 0)
                                            ? `ğŸ“Š äºˆæ¸¬è©•ä¾¡ +${total.toLocaleString()}pt`
                                            : "";
                                });
                            });

                            rotationContainer.appendChild(raceBlock);
                        }
                    });

                    setsContainer.appendChild(block);
                }
            });

            // --- ä¿å­˜ãƒœã‚¿ãƒ³å‡¦ç† ---
            document.getElementById("save-report").addEventListener("click", async () => {
                const loading = document.getElementById("loading");
                const saveBtn = document.getElementById("save-report");

                // çŠ¶æ…‹å¤‰æ›´
                saveBtn.disabled = true;
                loading.style.display = "block"; // ğŸ”„ è¡¨ç¤º

                const data = collectReportData();

                try {
                    const response = await fetch("{% url 'save_report' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify(data)
                    });

                    // ä¿å­˜å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®å‡¦ç†
                    if (response.ok) {
                        // ã™ãæ¶ˆã•ãšå°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œå‹•ã„ã¦ã‚‹ã€ã¨ã‚ã‹ã‚‹ã‚ˆã†ã«ï¼‰
                        setTimeout(() => {
                            loading.style.display = "none";
                            saveBtn.disabled = false;

                            // æ—¢ã«DLãƒœã‚¿ãƒ³ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ï¼ˆå¤šé‡ç”Ÿæˆé˜²æ­¢ï¼‰
                            const oldBtn = document.getElementById("download-json");
                            if (oldBtn) oldBtn.remove();

                            // ğŸ“¥ JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ä½œæˆ
                            const dlButton = document.createElement("button");
                            dlButton.id = "download-json";
                            dlButton.textContent = "â¬‡ï¸ JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
                            dlButton.className = "bg-blue-600 text-white px-4 py-2 rounded ml-2";
                            dlButton.addEventListener("click", () => {
                                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement("a");
                                a.href = url;
                                a.download = "report.json";
                                a.click();
                                URL.revokeObjectURL(url);
                            });

                            saveBtn.insertAdjacentElement("afterend", dlButton);
                        }, 1500); // 1.5ç§’å¾Œã«åˆ‡ã‚Šæ›¿ãˆ
                    } else {
                        loading.style.display = "none";
                        saveBtn.disabled = false;
                        console.error("âš ï¸ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    }
                } catch (err) {
                    loading.style.display = "none";
                    saveBtn.disabled = false;
                    console.error("âš ï¸ ã‚¨ãƒ©ãƒ¼:", err);
                }
            });

            // --- JSONæ§‹ç¯‰ ---
            function collectReportData() {
                const date = new Date();
                const formattedDate = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;

                const raceset = [];
                document.querySelectorAll(".bg-white").forEach((block, i) => {
                    const characterSelect = block.querySelector(".character-select");
                    const character = characterSelect?.value || "";
                    const tone = characterSelect?.selectedOptions[0]?.dataset.tone || "";
                    const prediction = characterSelect?.selectedOptions[0]?.dataset.prediction || "";
                    const index = characterSelect?.selectedOptions[0]?.dataset.index || "";

                    const raceData = [];
                    block.querySelectorAll(".rotation-container .border").forEach(raceBlock => {
                        const raceSelect = raceBlock.querySelector(".race-select");
                        if (!raceSelect) return; // â† ã“ã‚Œã‚’è¿½åŠ 

                        const selectedOption = raceSelect.selectedOptions[0];
                        if (!selectedOption) return; // â† ã“ã‚Œã‚‚å®‰å…¨ã®ãŸã‚è¿½åŠ 

                        const text = selectedOption.text || "";
                        const oddsMatch = text.match(/ï¼ˆ\s*([\d.]+)\s*å€ï¼‰/);
                        const odds = oddsMatch ? oddsMatch[1] : "";
                        const comboMatch = text.match(/\d-\d-\d/);
                        const combo = comboMatch ? comboMatch[0] : "";
                        const roundMatch = text.match(/(\d{1,2}R)/);
                        const round = roundMatch ? roundMatch[1] : "null";
                        const venue = selectedOption.dataset.venue || "null";
                        const pageUrl = raceSelect.value || "";

                        const amount = parseFloat(raceBlock.querySelector(".seed-input").value) || 0;
                        const ticketNum = parseFloat(raceBlock.querySelector(".points-input").value) || 1;
                        const purchase = Math.floor(amount / ticketNum);
                        const refund = odds ? Math.floor(parseFloat(odds) * 100) : 0;
                        const get = Math.floor(((amount / ticketNum) * parseFloat(odds)) / 10) * 10;

                        raceData.push({
                            "page": pageUrl,
                            "amount": amount.toString(),
                            "ticket-num": ticketNum.toString(),
                            "purchase": purchase,
                            "date": formattedDate,
                            "name": venue,
                            "round": round,
                            "3-ren": combo,
                            "refund": refund,
                            "odds": odds,
                            "get": get,
                            "time": "",
                            "image": "null"
                        });
                    });

                    raceset.push({
                        "date": formattedDate,
                        "character": character,
                        "tone": tone,
                        "prediction": prediction,
                        "index": index,
                        "race": raceData
                    });
                });

                return { "raceset": raceset };
            }
        });
    </script>
</body>

</html>