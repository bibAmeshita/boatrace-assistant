{% load static %}
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>ホームページ</title>
    <!-- TailwindCSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Quill -->
    <!--link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"-->
    <!--script src="https://cdn.quilljs.com/1.3.6/quill.js"></script-->
    <!-- あなたのスクリプト -->
    <!--script src="{% static 'ui/editor.js' %}"></script-->
</head>

<body class="bg-gray-50">
    {% block content %}
    <header class="bg-blue-900 p-6">
        <h1 class="text-2xl font-bold">BT</h1>
    </header>
    <nav class="flex gap-8 bg-gray-800 p-6">
        <a href="/" class="bg-gray-200 p-3" href>ダッシュボード</a>
        <a href="/prediction-1" class="bg-gray-200 p-3" href>事前予想</a>
        <a href="/prediction-2" class="bg-gray-200 p-3" href>直前予想</a>
        <a href="/report" class="bg-gray-200 p-3" href>予想結果</a>
        <a href="/result" class="bg-gray-200 p-3" href>結果画面作成</a>
        <a href="/media" class="bg-gray-200 p-3" href>メディア</a>
        <a href="/config" class="bg-gray-200 p-3" href>設定</a>
    </nav>
    <main class="p-6">
        <h2 class="text-2xl font-bold mb-12">直前予想</h2>
        <button id="fetchAll" class="bg-gray-500 text-white px-3 py-2 rounded grow">全てのレース取得</button>

        <div id="loading" style="display:none;">
            🔄 取得中...
        </div>

        <div id="raceForm" style="display:none; margin-top:20px;">
            <form id="predictionForm">

                <!-- ▼並び順切り替え -->
                <div id="sortToggle" style="margin:10px 0;">
                    <div class="flex gap-8 py-4">
                        <label class="w-28">並び順：</label>
                        <button type="button" id="sortByPlace"
                            style="background:#007bff;color:#fff;border:none;padding:4px 8px;border-radius:4px;">開催地順</button>
                        <button type="button" id="sortByTime"
                            style="background:#ccc;color:#000;border:none;padding:4px 8px;border-radius:4px;">時間順</button>
                    </div>
                </div>

                <!-- ▼レース選択 -->
                <div class="flex gap-8 py-2">
                    <label class="w-28">レース</label>
                    <select id="raceSelect" class="border rounded py-2 px-3  h-12">
                        <option value="">レースを選択してください</option>
                    </select>
                </div>

                <input type="hidden" id="place">
                <input type="hidden" id="title">
                <input type="hidden" id="race">
                <input type="hidden" id="deadline">
                <input type="hidden" id="raceUrl">
                <input type="hidden" id="date">


                <!-- ▼キャラクター -->
                <div class="flex gap-8 py-2">
                    <label class="w-28">キャラクター</label>
                    <select id="characterSelect" class="border rounded py-2 px-3  h-12">
                        <option value="">選択してください</option>
                        {% for c in characters %}
                        <option value="{{ c.id }}" data-tone="{{ c.tone }}" data-prediction="{{ c.prediction }}"
                            data-index="{{ c.index }}">
                            {{ c.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <input type="hidden" name="tone" id="charTone">
                <input type="hidden" name="prediction" id="charPrediction">
                <input type="hidden" name="index" id="charIndex">


                <!-- ▼式別 -->
                <div class="flex gap-8 py-2">
                    <label class="w-28">式別</label>
                    <select id="betType" name="betType" class="border rounded py-2 px-3  h-12">
                        <option value="" selected disabled>選択してください</option>
                        <option value="win">単勝</option>
                        <option value="place">複勝</option>
                        <option value="exacta">2連単</option>
                        <option value="quinella">2連複</option>
                        <option value="trifecta">3連単</option>
                        <option value="trio">3連複</option>
                    </select>
                </div>

                <!-- ▼方式 -->
                <div class="flex gap-8 py-2">
                    <label class="w-28">方式</label>
                    <select id="method" name="method" class="border rounded py-2 px-3  h-12">
                        <option value="" selected disabled>選択してください</option>
                        <option value="normal">通常</option>
                        <option value="1axle">1艇軸流し</option>
                        <option value="2axle">2艇軸流し</option>
                        <option value="3box">3艇ボックス</option>
                        <option value="4box">4艇ボックス</option>
                        <option value="5box">5艇ボックス</option>
                    </select>
                </div>

                <!-- ▼相手数（流し用） -->
                <div id="rivalWrap" style="display:none;">
                    <label class="w-28">相手数</label>
                    <select id="rivalCount" class="border rounded py-2 px-3  h-12">
                        <option value="">選択してください</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>

                <!-- ▼点数 -->
                <div class="flex gap-8 py-2">
                    <label class="w-28">購入点数</label>
                    <input id="pointsInput" name="points" type="number" placeholder="例: 5"
                        class="border rounded py-2 px-3 h-12">
                </div>
                <div id="pointInfo" class="pl-36" style="margin-top:5px;color:#555;">方式を選んでください</div>

                <!-- ▼キャラクター hidden -->
                <input type="hidden" id="charaStyle" name="charaStyle">
                <input type="hidden" id="charaPrediction" name="charaPrediction">
                <input type="hidden" id="charaIndex" name="charaIndex">

                <button type="submit" class="bg-gray-500 text-white px-3 py-2 mt-10 rounded grow">予想する</button>

            </form>
        </div>
    </main>

    {% endblock %}
</body>

</html>
<script>

    // ========================
    // 全レース取得（localStorage キャッシュ）
    // ========================
    document.getElementById("fetchAll").addEventListener("click", async () => {
        document.getElementById("loading").style.display = "block";
        const res = await fetch("/all_races_today/");
        const data = await res.json();
        document.getElementById("loading").style.display = "none";

        setupRaceOptions(data);
    });

    // ========================
    // 方式による点数・相手数制御
    // ========================
    document.getElementById("method").addEventListener("change", e => {
        const v = e.target.value; // "normal" / "1axle" / "2axle" / "3box" / "4box" / "5box"
        const betType = document.getElementById("betType").value;
        const rivalWrap = document.getElementById("rivalWrap");
        const rivalCount = document.getElementById("rivalCount");
        const pointsInput = document.getElementById("pointsInput");
        const pointInfo = document.getElementById("pointInfo");

        // 初期化
        rivalWrap.style.display = "none";
        rivalCount.value = "";
        pointsInput.readOnly = false;
        pointsInput.value = "";
        let msg = "自由に入力できます";

        // --- 流し系 ---
        if (v === "1axle" || v === "2axle") {
            rivalWrap.style.display = "block";
            msg = `${v === "1axle" ? "1軸" : "2軸"}流し：相手数を選択してください`;
        }

        // --- BOX系 ---
        if (v.endsWith("box")) {
            const n = parseInt(v, 10);
            const fixed = n * (n - 1) * (n - 2);
            pointsInput.value = fixed;
            pointsInput.readOnly = true;
            msg = `${n}艇ボックス：${fixed}点固定`;
        }

        pointInfo.textContent = msg;
    });

    // ========================
    // 相手数選択 → 自動点数反映
    // ========================
    document.getElementById("rivalCount").addEventListener("change", () => {
        const method = document.getElementById("method").value;
        const betType = document.getElementById("betType").value;
        const n = parseInt(document.getElementById("rivalCount").value);
        const pointsInput = document.getElementById("pointsInput");
        const pointInfo = document.getElementById("pointInfo");

        if (!n) return;

        let fixed = 0;

        if (method === "1axle") {
            if (betType === "trifecta") fixed = n * (n - 1);
            else if (betType === "trio") fixed = (n * (n - 1)) / 2;
            else fixed = n; // 2連単 or 2連複
        } else if (method === "2axle") {
            if (betType === "trifecta") fixed = 2 * n;
            else if (betType === "trio") fixed = n;
        }

        pointsInput.value = fixed;
        pointsInput.readOnly = true;
        pointInfo.textContent = `相手${n} → ${fixed}点固定`;
    });

    // ========================
    // キャラ選択：hiddenにセット
    // ========================
    document.getElementById("characterSelect").addEventListener("change", function () {
        const opt = this.selectedOptions[0];
        document.getElementById("charTone").value = opt.dataset.tone || "";
        document.getElementById("charPrediction").value = opt.dataset.prediction || "";
        document.getElementById("charIndex").value = opt.dataset.index || "";
    });

    // ========================
    // レース選択：hiddenにセット
    // ========================
    document.getElementById("raceSelect").addEventListener("change", () => {
        const v = document.getElementById("raceSelect").value;
        if (!v) return;

        const d = JSON.parse(v);
        document.getElementById("place").value = d.place;
        document.getElementById("title").value = d.title;
        document.getElementById("race").value = d.rno;
        document.getElementById("deadline").value = d.time;
        document.getElementById("raceUrl").value = d.url;
        document.getElementById("date").value = new Date().toISOString().slice(0, 10);
    });

    // ========================
    // 予想フォーム submit
    // ========================
    document.getElementById("predictionForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const v = document.getElementById("raceSelect").value;
        if (v) {
            const d = JSON.parse(v);
            document.getElementById("place").value = d.place;
            document.getElementById("title").value = d.title;
            document.getElementById("race").value = d.rno;
            document.getElementById("deadline").value = d.time;
            document.getElementById("raceUrl").value = d.url;
        }


        const betTypeMap = {
            win: "単勝", place: "複勝", exacta: "2連単", quinella: "2連複",
            trifecta: "3連単", trio: "3連複",
        };

        const methodMap = {
            normal: "通常", "1axle": "1軸流し", "2axle": "2軸流し",
            "3box": "3艇ボックス", "4box": "4艇ボックス", "5box": "5艇ボックス",
        };

        const data = {
            place: document.getElementById("place").value,
            title: document.getElementById("title").value,
            race: document.getElementById("race").value,
            deadline: document.getElementById("deadline").value,
            raceUrl: document.getElementById("raceUrl").value,
            character: document.querySelector("#characterSelect option:checked").textContent.trim(),
            charTone: document.getElementById("charTone").value,
            charPrediction: document.getElementById("charPrediction").value,
            charIndex: document.getElementById("charIndex").value,
            betType: betTypeMap[document.getElementById("betType").value],
            method: methodMap[document.getElementById("method").value],
            points: document.getElementById("pointsInput").value,
        };

        //console.table(data);

        sendPrediction(data);
    });

    async function sendPrediction(data) {
        //console.log("送信data:", data);
        // ① レース詳細取得
        const detail = await fetch("/today_race_detail/just/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
        });
        const raceJson = await detail.json();
        //console.log("データ:", raceJson);

        // ② 予測（スコア付与 & 保存）
        const res = await fetch("/predictor_2/race_predict/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(raceJson),
        });
        const finalJson = await res.json();

        // ③ ダウンロードボタン表示
        const btn = document.createElement("button");
        btn.textContent = "JSONをダウンロード";
        btn.style.marginTop = "10px";
        btn.onclick = () => {
            const blob = new Blob([JSON.stringify(finalJson, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `race_${finalJson.place}_${finalJson.race}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        document.body.appendChild(btn);
        alert("保存しました！");
    }

    // ========================
    // レース選択肢反映
    // ========================
    function setupRaceOptions(data) {
        const raceSelect = document.getElementById("raceSelect");
        const btnPlace = document.getElementById("sortByPlace");
        const btnTime = document.getElementById("sortByTime");
        let sortMode = "place"; // デフォルト：開催地順

        // 🔁 並び順変更ボタンの見た目更新
        const updateButtons = () => {
            if (sortMode === "place") {
                btnPlace.style.background = "#007bff";
                btnPlace.style.color = "#fff";
                btnTime.style.background = "#ccc";
                btnTime.style.color = "#000";
            } else {
                btnPlace.style.background = "#ccc";
                btnPlace.style.color = "#000";
                btnTime.style.background = "#007bff";
                btnTime.style.color = "#fff";
            }
        };

        // 🧩 レースリスト描画
        const renderOptions = () => {
            raceSelect.innerHTML = `<option value="">レースを選択してください</option>`;

            let allRaces = [];
            data.forEach(site => {
                site.races.forEach(r => {
                    allRaces.push({
                        place: site.place,
                        title: site.title,
                        rno: r.rno,
                        time: r.time,
                        url: r.url
                    });
                });
            });

            if (sortMode === "time") {
                // 時間昇順ソート
                allRaces.sort((a, b) => a.time.localeCompare(b.time));
            } else {
                // 開催地→レース番号順
                allRaces.sort((a, b) => {
                    if (a.place === b.place) {
                        return a.rno.localeCompare(b.rno);
                    }
                    return a.place.localeCompare(b.place);
                });
            }

            allRaces.forEach(r => {
                const opt = document.createElement("option");
                opt.value = JSON.stringify(r);
                opt.textContent =
                    sortMode === "time"
                        ? `${r.time}　${r.place} ${r.rno}`
                        : `${r.place} ${r.rno} (${r.time})`;
                raceSelect.appendChild(opt);
            });
        };

        // 🎛 イベント設定
        btnPlace.addEventListener("click", () => {
            sortMode = "place";
            updateButtons();
            renderOptions();
        });
        btnTime.addEventListener("click", () => {
            sortMode = "time";
            updateButtons();
            renderOptions();
        });

        // 初期表示
        updateButtons();
        renderOptions();
        document.getElementById("raceForm").style.display = "block";
    }

</script>